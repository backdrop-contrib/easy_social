<?php
/**
 * @file Easy social module.
 * 
 */

module_load_include('inc', 'easy_social');

/**
 * Implements hook_permission().
 */
function easy_social_permission() {
  return array(
    'administer easy social' => array(
      'title' => t('Administer Easy Social'),
      'description' => t('Manage Easy Social permissions.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function easy_social_menu() {
  $items = array();

  $items['admin/config/content/easysocial'] = array(
    'title' => 'Easy Social Settings',
    'description' => 'Configure the social buttons and node types',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('admin_config_easy_social'),
    'access arguments' => array('administer easy social'),
  );

  $items['admin/config/content/easysocial/default'] = array(
    'title' => 'Easy Social Settings',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );

  $items['admin/config/content/easysocial/paths-ignore'] = array(
    'title' => 'Ignore Paths',
    'description' => 'Global paths to ignore and do not display Easy Social',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('admin_config_easy_social_ignore_paths'),
    'access arguments' => array('administer easy social'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Implements hook_variable_info().
 */
function easy_social_variable_info() {

  $variables['easysocial_ignore_paths'] = array(
    'title' => t('Easy Social Global Ignore Paths'),
    'default' => '',
    'group' => 'easysocial',
    'token' => FALSE,
  );

  $variables['easysocial_global_typebtn'] = array(
    'title' => t('Easy Social Global Type of Buttons'),
    'default' => 0,
    'group' => 'easysocial',
    'token' => FALSE,
  );

  $variables['easysocial_global_social_buttons'] = array(
    'title' => t('Easy Social Global Type of Network Buttons'),
    'default' => array('twitter', 'facebook', 'googleplus', 'linkedin'),
    'group' => 'easysocial',
    'token' => FALSE,
  );

  $variables['easysocial_tt_global_account_via'] = array(
    'title' => t('Easy Social Global Mention Account'),
    'default' => '',
    'group' => 'easysocial',
    'token' => FALSE,
  );

  $variables['easysocial_tt_global_account_related'] = array(
    'title' => t('Easy Social Global Related Account'),
    'default' => '',
    'group' => 'easysocial',
    'token' => FALSE,
  );

  $variables['easysocial_tt_global_account_description'] = array(
    'title' => t('Easy Social Global Twitter Description'),
    'default' => 'Check it out: !title',
    'group' => 'easysocial',
    'token' => FALSE,
  );

  $node_types = node_type_get_types();

  foreach ($node_types as $type => $typeobj) {

    $variables['easysocial_' . $type . '_override'] = array(
      'title' => t('Easy Social Override Option for type %type', array('%type' => $typeobj->name)),
      'default' => -1,
      'group' => 'easysocial',
      'token' => FALSE,
    );

    $variables['easysocial_' . $type . '_typebtn'] = array(
      'title' => t('Easy Social Type of Buttons for %type', array('%type' => $typeobj->name)),
      'default' => -1,
      'group' => 'easysocial',
      'token' => FALSE,
    );

    $variables['easysocial_' . $type . '_social_buttons'] = array(
      'title' => t('Easy Social Network Buttons for %type', array('%type' => $typeobj->name)),
      'default' => array(),
      'group' => 'easysocial',
      'token' => FALSE,
    );
  }

  return $variables;
}

function admin_config_easy_social() {
  $form = array();

  $form['global_settings'] = array(
    '#type' => 'fieldset',
    '#title' => t('Global Settings'),
    '#description' => t('Settings available for all content types'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );

  $form['global_settings']['easysocial_global_typebtn'] = array(
    '#type' => 'radios',
    '#title' => t('Type of buttons'),
    '#options' => array(t('Horizontal'), t('Vertical')),
    '#default_value' => variable_get_value('easysocial_global_typebtn'),
  );

  $widgets = easy_social_get_widgets();
  $options = array();
  
  foreach ($widgets as $k => $widget) {
    $options[$k] = isset($widget['name']) ? $widget['name'] : $k;
  }
  
  $form['global_settings']['easysocial_global_social_buttons'] = array(
    '#type' => 'checkboxes',
    '#title' => t('Social Buttons'),
    '#options' => $options,
    '#default_value' => variable_get_value('easysocial_global_social_buttons'),
  );

  /**
   * @TODO figure out how to deal with extra settings fields for widgets
   */
  
  $form['global_settings']['twitter_global_data'] = array(
    '#type' => 'fieldset',
    '#title' => t('Twitter Info'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );

  $form['global_settings']['twitter_global_data']['easysocial_tt_global_account_via'] = array(
    '#type' => 'textfield',
    '#title' => t('Mention account'),
    '#size' => 40,
    '#maxlength' => 255,
    '#default_value' => variable_get_value('easysocial_tt_global_account_via'),
  );

  $form['global_settings']['twitter_global_data']['easysocial_tt_global_account_related'] = array(
    '#type' => 'textfield',
    '#title' => t('Related account'),
    '#size' => 40,
    '#maxlength' => 255,
    '#default_value' => variable_get_value('easysocial_tt_global_account_related'),
  );

  $form['global_settings']['twitter_global_data']['easysocial_tt_global_account_description'] = array(
    '#type' => 'textfield',
    '#title' => t('Related account description'),
    '#size' => 120,
    '#maxlength' => 120,
    '#default_value' => variable_get_value('easysocial_tt_global_account_description'),
    '#description' => 'Use !title for the current page title'
  );

  $form['override_settings'] = array(
    '#type' => 'fieldset',
    '#title' => t('Override Settings by Content Type'),
    '#description' => t('Settings by Content Type'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
  );

  $node_types = node_type_get_types();

  // sometimes when dealing with feature-defined content types they appear out of order
  // since this is an admin page we prefer organization over performance so go ahead and sort it
  ksort($node_types);

  foreach ($node_types as $type => $typeobj) {

    $form['override_settings']['easysocial_settings_type_' . $type] = array(
      '#type' => 'fieldset',
      '#title' => t('Custom Settings for %type', array('%type' => $typeobj->name)),
      '#collapsible' => TRUE,
      '#collapsed' => TRUE,
    );

    $form['override_settings']['easysocial_settings_type_' . $type]['easysocial_' . $type . '_override'] = array(
      '#type' => 'checkbox',
      '#title' => t('Override'),
      '#description' => t('Check this option to override the global settings for this type'),
      '#default_value' => variable_get_value('easysocial_' . $type . '_override'),
    );

    $form['override_settings']['easysocial_settings_type_' . $type]['easysocial_' . $type . '_typebtn'] = array(
      '#type' => 'radios',
      '#title' => t('Type of buttons'),
      // '#description' => t('Type of buttons, horizontal or vertical.'),
      '#options' => array(t('Horizontal'), t('Vertical')),
      '#default_value' => variable_get_value('easysocial_' . $type . '_typebtn')
    );

    $form['override_settings']['easysocial_settings_type_' . $type]['easysocial_' . $type . '_social_buttons'] = array(
      '#type' => 'checkboxes',
      '#title' => t('Social Buttons'),
      '#options' => array('twitter' => 'Twitter', 'facebook' => 'Facebook', 'googleplus' => 'Google Plus', 'linkedin' => 'Linked In'),
      '#default_value' => variable_get_value('easysocial_' . $type . '_social_buttons'),
    );
  }

  $form = system_settings_form($form);

  return $form;
}

/**
 * Form callback
 * Return settings form for ignore-paths
 */
function admin_config_easy_social_ignore_paths() {
  $form = array();

  $form['easysocial_ignore_paths'] = array(
    '#type' => 'textarea',
    '#title' => t('Ignore paths'),
    '#description' => t('Every URL placed here, will not have any Social links.'),
    '#default_value' => variable_get_value('easysocial_ignore_paths'),
  );

  $form = system_settings_form($form);

  return $form;
}

/**
 * Implements hook_theme().
 */
function easy_social_theme() {
  $theme = array(
    'easy_social_links' => array(
      'template' => 'easy-social-links',
      'variables' => array('social_links' => NULL),
    ),
  );
  return $theme;
}

/**
 * Implements hook_field_extra_fields().
 * The Easy Social available in Manage display page in the content types
 */
function easy_social_field_extra_fields() {
  $extra = array();
  $node_types = node_type_get_types();
  foreach ($node_types as $type => $typeobj) {
    $extra['node'][$type] = array(
      'display' => array(
        'easy_social' => array(
          'label' => t('Easy Social'),
          'weight' => 100,
        ),
      ),
    );
  }
  return $extra;
}

/**
 * Implements hook_node_view().
 * Certify to load the buttons in the moment I want
 */
function easy_social_node_view($node, $view_mode, $langcode) {

  // Check if the path is ignored
  $urls_ignored = variable_get_value('easysocial_ignore_paths');

  $page_match = FALSE;

  $path = drupal_get_path_alias($_GET['q']);

  // Compare with the internal and path alias (if any).
  $page_match = drupal_match_path($path, $urls_ignored);

  if ($path != $_GET['q']) {
    $page_match = $page_match || drupal_match_path($_GET['q'], $urls_ignored);
  }

  if (!$page_match) {
    //Check if this type has a custom setting
    if (variable_get_value('easysocial_' . $node->type . '_override') == 1) {
      $type = variable_get_value('easysocial_' . $node->type . '_typebtn');
      $buttons = variable_get_value('easysocial_' . $node->type . '_social_buttons');
    }
    //Global settings
    else {
      // @TODO figure out how to deal with wiget-defined variables
      $type = variable_get_value('easysocial_global_typebtn');
      $buttons = variable_get_value('easysocial_global_social_buttons');
    }

    //Url to be shared
    $url = url('node/' . $node->nid, array('absolute' => TRUE));

    $social_links = array();
    $widgets = easy_social_get_widgets();

    //Load Js files and generate respective markups
    foreach ($buttons as $service) {
      if (is_string($service)) {
        $data = array(
          'nid' => $node->nid,
          'title' => $node->title
        );
        
        // add external javascript, if any
        if (isset($widgets[$service]['script'])) {
          drupal_add_js($widgets[$service]['script'], 'external');
        }

        if (isset($widgets[$service]['markup'])) {
          $social_links[$service] = call_user_func($widgets[$service]['markup'], $url, $type, $data);
        }
      }
    }

    //If at least one button is selected, go on
    if (count($social_links) > 0) {
      $node->content['easy_social'] = array(
        '#theme' => 'easy_social_links',
        '#social_links' => $social_links,
        '#weight' => 999
      );
    }
  }
}

/**
 * Returns a list of enabled social widgets
 * Results are cached
 * 
 * @return array
 * @TODO implement static cache
 */
function easy_social_get_widgets() {
  $cache = cache_get('easy_social_widgets');

  if (isset($cache->data) && is_array($cache->data)) {
    $return = $cache->data;
  }
  else {
    $return = array();

    foreach (module_implements('easy_social_widget') as $name) {
      $widgets = module_invoke($name, 'easy_social_widget');
      $return = array_merge($return, $widgets);
    }

    cache_set('easy_social_widgets', $return, 'bin', CACHE_TEMPORARY);
  }

  return $return;
}

/**
 * Implements hook_easy_social_widgets().
 */
function easy_social_easy_social_widget() {
  return array(
    'facebook' => array(
      'name' => 'Facebook',
      'markup' => '_easysocial_widget_facebook_markup',
      'script' => 'http://static.ak.fbcdn.net/connect.php/js/FB.Share',
    ),
    'googleplus' => array(
      'name' => 'Google+',
      'markup' => '_easysocial_widget_googleplus_markup',
      'script' => 'https://apis.google.com/js/plusone.js',
    ),
    'linkedin' => array(
      'name' => 'LinkedIn',
      'markup' => '_easysocial_widget_linkedin_markup',
      'script' => 'http://platform.linkedin.com/in.js',
    ),
    'twitter' => array(
      'name' => 'Twitter',
      'markup' => '_easysocial_widget_twitter_markup',
      'script' => 'http://platform.twitter.com/widgets.js',
    ),
  );
}

/**
 * Implements hook_init().
 * 
 * @todo remove this, only here for debugging
 */
function easy_social_init() {
//  include_once drupal_get_path('module', 'devel') . '/krumo/class.krumo.php';
//  krumo(easy_social_get_widgets());
//  die;
}